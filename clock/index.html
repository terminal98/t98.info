<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NTP Digital Clock with Timer</title>

  <!-- Web App Manifest とテーマカラーを追加 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    /* 基本的なリセットと全体設定 */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      /* スクロールバーを非表示 */
    }

    /* 時計全体のコンテナ設定 */
    #clock-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
      /* 画面全体の高さ */
      background-color: #000000;
      /* 背景色: 黒 */
      color: #ffffff;
      /* 文字色: 白 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      /* クリック可能であることを示すカーソル */
    }

    /* 1段目: 時刻表示 */
    #time {
      line-height: 1.0;
      display: flex;
      align-items: baseline;
    }

    /* 数字部分のスタイル */
    .mono {
      font-variant-numeric: tabular-nums;
    }

    /* コロン部分のスタイル */
    .colon {
      margin: 0 0.05em;
    }

    /* 2段目: 日付とタイマー表示 */
    #date-container {
      display: flex;
      justify-content: center;
      align-items: baseline;
      flex-wrap: wrap;
      /* 画面が狭い場合に折り返す */
      line-height: 1.2;
    }

    #date {
      margin-right: 0.5em;
      /* 日付とタイマーの間に余白 */
    }

    .unit {
      font-size: 0.6em;
      /* 数字に対してフォントを小さくする */
      font-weight: normal;
      /* 少し細字にする */
      margin: 0 0.1em;
    }

    /* 残り時間表示のスタイル */
    #timer-display {
      font-weight: bold;
    }

    .timer-green {
      color: #5cb85c;
    }

    /* 90分以上: 緑 */
    .timer-yellow {
      color: #f0ad4e;
    }

    /* 30-90分: 黄 */
    .timer-red {
      color: #d9534f;
    }

    /* 30分未満: 赤 */

    /* NTP同期ステータス表示 */
    #ntp-status {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #ffffff;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ntp-syncing {
      background-color: #f0ad4e;
    }

    .ntp-success {
      background-color: #5cb85c;
    }

    .ntp-error {
      background-color: #808080;
    }

    /* --- タイマー設定関連のスタイル --- */
    #settings-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.2s ease-in-out;
    }

    #settings-icon:hover {
      transform: rotate(45deg);
    }

    #settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    #settings-modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #2c2c2c;
      padding: 25px;
      border-radius: 10px;
      color: #fff;
      text-align: center;
      font-family: 'Arial', sans-serif;
      width: 90%;
      max-width: 380px;
    }

    .modal-content h2 {
      margin-top: 0;
      font-size: 1.5em;
    }

    .time-input-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }

    .time-input-container button {
      font-size: 1.5em;
      width: 40px;
      height: 40px;
      margin: 0 10px;
    }

    #time-input {
      font-size: 2em;
      width: 120px;
      text-align: center;
      border: 1px solid #555;
      background-color: #333;
      color: #fff;
      border-radius: 5px;
    }

    .quick-adjust-buttons button {
      margin: 5px;
      padding: 8px 12px;
    }

    .sound-toggle {
      margin-top: 20px;
      font-size: 1.1em;
    }

    .modal-actions {
      margin-top: 25px;
    }

    .modal-actions button {
      padding: 10px 20px;
      font-size: 1.1em;
      margin: 0 10px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }

    #save-settings {
      background-color: #5cb85c;
      color: white;
    }

    #cancel-timer {
      background-color: #d9534f;
      color: white;
    }
  </style>
</head>

<body>
  <!-- NTPステータス表示用の要素 -->
  <div id="ntp-status" class="ntp-error">NTP</div>

  <div id="clock-container">
    <div id="time">
      <span id="hour" class="mono">--</span>
      <span class="colon">:</span>
      <span id="minute" class="mono">--</span>
      <span class="colon">:</span>
      <span id="second" class="mono">--</span>
    </div>
    <div id="date-container">
      <div id="date">--月--日(-)</div>
      <div id="timer-display"></div>
    </div>
  </div>

  <!-- タイマー設定アイコン (SVG) -->
  <div id="settings-icon">
    <svg viewBox="0 0 24 24" fill="white">
      <path
        d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
    </svg>
  </div>

  <!-- タイマー設定モーダル -->
  <div id="settings-modal">
    <div class="modal-content">
      <h2>タイマー設定</h2>
      <div class="time-input-container">
        <button id="dec-15min">-</button>
        <input type="time" id="time-input">
        <button id="inc-15min">+</button>
      </div>
      <div class="quick-adjust-buttons">
        <button data-adjust="30">+30分</button>
        <button data-adjust="60">+1時間</button>
      </div>
      <div class="sound-toggle">
        <label>
          <input type="checkbox" id="sound-checkbox" checked>
          通知音を鳴らす
        </label>
      </div>
      <div class="modal-actions">
        <button id="save-settings">設定</button>
        <button id="cancel-timer">解除</button>
      </div>
    </div>
  </div>

  <audio id="alarm-sound" src="beep.mp3" preload="auto"></audio>


  <script>
    // --- 要素の取得 ---
    const timeElement = document.getElementById('time');
    const dateElement = document.getElementById('date');
    const ntpStatusElement = document.getElementById('ntp-status');
    const clockContainer = document.getElementById('clock-container');
    const hourElement = document.getElementById('hour');
    const minuteElement = document.getElementById('minute');
    const secondElement = document.getElementById('second');
    const timerDisplayElement = document.getElementById('timer-display');
    const settingsIcon = document.getElementById('settings-icon');
    const settingsModal = document.getElementById('settings-modal');
    const timeInput = document.getElementById('time-input');
    const soundCheckbox = document.getElementById('sound-checkbox');
    const alarmSound = document.getElementById('alarm-sound');

    const week = ['日', '月', '火', '水', '木', '金', '土'];
    let timeOffset = 0;
    let targetDate = null;
    let soundEnabled = true;
    const playedAlarms = new Set();

    function padZero(num) {
      return num.toString().padStart(2, '0');
    }

    function displayTime() {
      const now = new Date(Date.now() + timeOffset);
      hourElement.textContent = padZero(now.getHours());
      minuteElement.textContent = padZero(now.getMinutes());
      secondElement.textContent = padZero(now.getSeconds());
      const month = now.getMonth() + 1;
      const day = now.getDate();
      const dayOfWeek = week[now.getDay()];
      dateElement.innerHTML = `${month}<span class="unit">月</span>${day}<span class="unit">日(${dayOfWeek})</span>`;
      updateTimerDisplay(now);
    }

    function updateTimerDisplay(now) {
      if (!targetDate) {
        timerDisplayElement.innerHTML = '';
        return;
      }
      const remainingMs = targetDate.getTime() - now.getTime();
      if (remainingMs <= 0) {
        timerDisplayElement.innerHTML = '<span class="unit">時間です</span>';
        timerDisplayElement.className = 'timer-red';
        if (soundEnabled && !playedAlarms.has(0)) {
          playSound();
          playedAlarms.add(0);
        }
        return;
      }
      const remainingMinutes = Math.ceil(remainingMs / 60000);
      if (remainingMinutes >= 90) {
        const remainingHours = Math.ceil(remainingMs / 3600000);
        timerDisplayElement.innerHTML = `<span class="unit">残り </span>${remainingHours}<span class="unit">時間</span>`;
        timerDisplayElement.className = 'timer-green';
      } else {
        timerDisplayElement.innerHTML = `<span class="unit">残り </span>${remainingMinutes}<span class="unit">分</span>`;
        timerDisplayElement.className = remainingMinutes < 30 ? 'timer-red' : 'timer-yellow';
      }
      const alarmPoints = [90, 60, 30, 15, 5, 1];
      for (const point of alarmPoints) {
        if (remainingMinutes === point && !playedAlarms.has(point)) {
          if (soundEnabled) playSound();
          playedAlarms.add(point);
          break;
        }
      }
    }

    function playSound() {
      alarmSound.currentTime = 0;
      alarmSound.play().catch(error => console.error("音声の再生に失敗しました:", error));
    }

    /**
     * MODIFIED: オフライン状態を最初にチェックするように変更
     */
    async function syncTimeWithNTP(maxRetries = 3, retryDelay = 3000) {
      // オフラインの場合は、NTP同期を試みずにローカル時刻を使用する
      if (!navigator.onLine) {
        console.warn('Offline. Using local time.');
        timeOffset = 0;
        ntpStatusElement.className = 'ntp-error';
        ntpStatusElement.textContent = 'Offline';
        ntpStatusElement.title = 'オフラインのため、端末の時刻を使用しています。';
        return;
      }

      ntpStatusElement.className = 'ntp-syncing';
      ntpStatusElement.textContent = 'NTP';
      ntpStatusElement.title = 'NTPサーバーと同期中...';

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Tokyo');
          if (!response.ok) throw new Error(`NTPサーバーエラー: ${response.status}`);
          const data = await response.json();
          const serverTime = new Date(data.utc_datetime).getTime();
          timeOffset = serverTime - Date.now();
          console.log(`NTP同期完了 (試行: ${attempt}回)`);
          ntpStatusElement.className = 'ntp-success';
          ntpStatusElement.title = `NTP同期成功 (最終同期: ${new Date().toLocaleTimeString()})`;
          return;
        } catch (error) {
          console.warn(`NTP試行 ${attempt}回目失敗: ${error.message}`);
          if (attempt < maxRetries) await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
      }

      console.warn('NTP同期失敗。ローカル時刻を使用します。');
      timeOffset = 0;
      ntpStatusElement.className = 'ntp-error';
      ntpStatusElement.title = 'NTP同期失敗。ローカル時刻を使用しています。';
    }

    function adjustFontSize() {
      const containerWidth = clockContainer.clientWidth;
      const timeFontSize = containerWidth / 5.5;
      const dateFontSize = timeFontSize / 3.5;
      timeElement.style.fontSize = `${timeFontSize}px`;
      dateElement.parentElement.style.fontSize = `${dateFontSize}px`;
    }

    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => console.error(`全画面表示エラー: ${err.message}`));
      } else if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    }

    function openSettingsModal() {
      if (targetDate && (targetDate.getTime() > (Date.now() + timeOffset))) {
        timeInput.value = `${padZero(targetDate.getHours())}:${padZero(targetDate.getMinutes())}`;
      } else {
        const now = new Date(Date.now() + timeOffset);
        timeInput.value = `${padZero(now.getHours())}:${padZero(now.getMinutes())}`;
      }
      settingsModal.classList.add('visible');
    }

    function closeSettingsModal() {
      settingsModal.classList.remove('visible');
    }

    function adjustTimeRound15(direction) {
      const [h, m] = timeInput.value.split(':').map(Number);
      const date = new Date();
      date.setHours(h, m, 0, 0);

      if (direction === 'increment') {
        const newMinute = Math.ceil((m + 1) / 15) * 15;
        date.setMinutes(newMinute);
      } else if (direction === 'decrement') {
        const minutesToProcess = (m === 0) ? 60 : m;
        const newMinute = Math.floor((minutesToProcess - 1) / 15) * 15;
        if (m === 0) {
          date.setHours(date.getHours() - 1);
        }
        date.setMinutes(newMinute);
      }
      timeInput.value = `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
    }

    function adjustTime(minutes) {
      const [h, m] = timeInput.value.split(':').map(Number);
      const date = new Date();
      date.setHours(h, m, 0, 0);
      const currentMinutes = date.getMinutes();
      const newMinute = Math.ceil((currentMinutes + 1) / minutes) * minutes;
      date.setMinutes(newMinute);
      timeInput.value = `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
    }

    function setupEventListeners() {
      window.addEventListener('resize', adjustFontSize);
      clockContainer.addEventListener('click', toggleFullScreen);
      settingsIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        openSettingsModal();
      });
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) closeSettingsModal();
      });
      document.getElementById('save-settings').addEventListener('click', () => {
        const [hours, minutes] = timeInput.value.split(':').map(Number);
        targetDate = new Date(Date.now() + timeOffset);
        targetDate.setHours(hours, minutes, 0, 0);
        if (targetDate.getTime() < (Date.now() + timeOffset)) {
          targetDate.setDate(targetDate.getDate() + 1);
        }
        soundEnabled = soundCheckbox.checked;
        playedAlarms.clear();
        closeSettingsModal();
        displayTime();
      });
      document.getElementById('cancel-timer').addEventListener('click', () => {
        targetDate = null;
        closeSettingsModal();
      });
      document.getElementById('dec-15min').addEventListener('click', () => adjustTimeRound15('decrement'));
      document.getElementById('inc-15min').addEventListener('click', () => adjustTimeRound15('increment'));
      document.querySelectorAll('.quick-adjust-buttons button').forEach(button => {
        button.addEventListener('click', () => {
          const minutes = parseInt(button.dataset.adjust, 10);
          adjustTime(minutes);
        });
      });
    }

    (() => {
      adjustFontSize();
      setupEventListeners();
      displayTime();
      setInterval(displayTime, 1000);
      syncTimeWithNTP();
      setInterval(syncTimeWithNTP, 3600000);

      // --- NEW: Service Worker の登録処理 ---
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(err => {
              console.error('Service Worker registration failed:', err);
            });
        });
      }
    })();
  </script>

</body>

</html>