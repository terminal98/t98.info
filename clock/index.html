<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NTP Digital Clock with Timekeeper</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    :root {
      --bg: #000000;
      --fg: #ffffff;
    }

    #clock-container {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
      background-color: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    #heading-group {
      position: absolute;
      top: 12px;
      left: 16px;
      max-width: calc(100vw - 220px);
      z-index: 5;
      display: none;
    }

    #timekeeper-heading {
      max-width: 100%;
      font-size: clamp(32px, 5.4vw, 78px);
      font-weight: 700;
      text-align: left;
      line-height: 1.2;
      word-break: break-word;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #target-time {
      max-width: 100%;
      font-size: clamp(24px, 4vw, 56px);
      font-weight: 700;
      text-align: left;
      line-height: 1.2;
      word-break: break-word;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #nav-buttons {
      position: absolute;
      top: 16px;
      right: 16px;
      display: none;
      gap: 8px;
      z-index: 5;
    }

    .nav-button {
      padding: 9px 14px;
      font-size: 16px;
      border: 1px solid currentColor;
      border-radius: 8px;
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    #skip-button,
    #back-button {
      z-index: 5;
      display: none;
    }

    #time {
      line-height: 1.0;
      display: flex;
      align-items: baseline;
      font-variant-numeric: tabular-nums;
      font-size: clamp(64px, 20vw, 260px);
      margin: 0 10px;
    }

    #keeper-time {
      display: none;
      line-height: 1.0;
      font-variant-numeric: tabular-nums;
      font-size: clamp(104px, 30vw, 420px);
      letter-spacing: 0.02em;
      margin: 0 10px;
    }

    #keeper-time .keeper-min,
    #keeper-time .keeper-sep {
      font-size: 1em;
    }

    #keeper-time .keeper-sec {
      font-size: 0.78em;
    }

    .mono {
      font-variant-numeric: tabular-nums;
    }

    .colon {
      margin: 0 0.05em;
    }

    #date-container {
      display: flex;
      justify-content: center;
      align-items: baseline;
      flex-wrap: wrap;
      line-height: 1.2;
      font-size: clamp(24px, 4.3vw, 72px);
      margin-top: 8px;
      padding: 0 12px;
    }

    #date {
      margin-right: 0.5em;
    }

    .unit {
      font-size: 0.6em;
      font-weight: normal;
      margin: 0 0.1em;
    }

    #timer-display {
      font-weight: 700;
    }

    #ntp-status {
      position: absolute;
      top: auto;
      bottom: 15px;
      left: 15px;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #ffffff;
      font-family: Arial, sans-serif;
      font-weight: bold;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ntp-syncing {
      background-color: #f0ad4e;
    }

    .ntp-success {
      background-color: #5cb85c;
    }

    .ntp-error {
      background-color: #808080;
    }

    #settings-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.2s ease-in-out;
    }

    #settings-icon:hover {
      transform: rotate(45deg);
    }

    #settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    #settings-modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
      color: #fff;
      font-family: Arial, sans-serif;
      width: min(95vw, 680px);
      max-height: 86vh;
      overflow: auto;
      text-align: left;
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.4em;
      text-align: center;
    }

    .helper {
      opacity: 0.85;
      font-size: 0.9em;
      margin: 0 0 12px;
      text-align: center;
    }

    #schedule-list {
      display: grid;
      gap: 8px;
      margin-bottom: 12px;
    }

    .schedule-row {
      display: grid;
      grid-template-columns: 1fr 120px 72px;
      gap: 8px;
      align-items: center;
    }

    .schedule-row input[type="text"],
    .schedule-row input[type="time"] {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      background: #1d1d1d;
      color: #fff;
      border-radius: 6px;
      padding: 8px;
      font-size: 15px;
    }

    .schedule-row button {
      border: 1px solid #777;
      background: #3a3a3a;
      color: #fff;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
    }

    #add-item {
      width: 100%;
      margin: 6px 0 14px;
      border: 1px solid #6f8cff;
      background: #253266;
      color: #fff;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      font-size: 15px;
    }

    .toggle-area {
      display: grid;
      gap: 8px;
      margin-bottom: 14px;
      font-size: 0.95em;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .modal-actions button {
      padding: 10px 14px;
      font-size: 1em;
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    #save-settings {
      background-color: #5cb85c;
      color: #fff;
    }

    #clear-settings {
      background-color: #d9534f;
      color: #fff;
    }

    #close-settings {
      background-color: #777;
      color: #fff;
    }

    @media (max-width: 640px) {
      .schedule-row {
        grid-template-columns: 1fr;
      }

      #heading-group {
        top: 8px;
        max-width: calc(100vw - 32px);
      }

      #nav-buttons {
        top: auto;
        right: 16px;
        bottom: 72px;
      }
    }
  </style>
</head>

<body>
  <div id="ntp-status" class="ntp-error">NTP</div>

  <div id="clock-container">
    <div id="heading-group">
      <div id="timekeeper-heading"></div>
      <div id="target-time"></div>
    </div>
    <div id="nav-buttons">
      <button id="back-button" class="nav-button" type="button">戻る</button>
      <button id="skip-button" class="nav-button" type="button">スキップ</button>
    </div>

    <div id="time">
      <span id="hour" class="mono">--</span>
      <span class="colon">:</span>
      <span id="minute" class="mono">--</span>
      <span class="colon">:</span>
      <span id="second" class="mono">--</span>
    </div>
    <div id="keeper-time">--</div>

    <div id="date-container">
      <div id="date">--月--日(-)</div>
      <div id="timer-display"></div>
    </div>
  </div>

  <div id="settings-icon">
    <svg viewBox="0 0 24 24" fill="white">
      <path
        d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
    </svg>
  </div>

  <div id="settings-modal">
    <div class="modal-content">
      <h2>タイムキーパー設定</h2>
      <p class="helper">見出し(メモ) + 時刻を最大15件まで設定できます。</p>

      <div id="schedule-list"></div>
      <button id="add-item" type="button">項目を追加</button>

      <div class="toggle-area">
        <label><input type="checkbox" id="color-alert-checkbox" checked> 残り3分/1分で色変更を有効にする</label>
        <label><input type="checkbox" id="sound-checkbox" checked> 通知音を鳴らす</label>
      </div>

      <div class="modal-actions">
        <button id="save-settings" type="button">保存</button>
        <button id="clear-settings" type="button">全削除</button>
        <button id="close-settings" type="button">閉じる</button>
      </div>
    </div>
  </div>

  <audio id="alarm-sound" src="beep.mp3" preload="auto"></audio>

  <script>
    const SETTINGS_KEY = 'clock-timekeeper-settings-v1';
    const MAX_ITEMS = 15;

    const week = ['日', '月', '火', '水', '木', '金', '土'];

    const timeElement = document.getElementById('time');
    const dateElement = document.getElementById('date');
    const timerDisplayElement = document.getElementById('timer-display');
    const ntpStatusElement = document.getElementById('ntp-status');
    const clockContainer = document.getElementById('clock-container');
    const keeperTimeElement = document.getElementById('keeper-time');
    const hourElement = document.getElementById('hour');
    const minuteElement = document.getElementById('minute');
    const secondElement = document.getElementById('second');

    const headingGroupElement = document.getElementById('heading-group');
    const headingElement = document.getElementById('timekeeper-heading');
    const targetTimeElement = document.getElementById('target-time');
    const navButtons = document.getElementById('nav-buttons');
    const backButton = document.getElementById('back-button');
    const skipButton = document.getElementById('skip-button');

    const settingsIcon = document.getElementById('settings-icon');
    const settingsModal = document.getElementById('settings-modal');
    const scheduleListElement = document.getElementById('schedule-list');
    const addItemButton = document.getElementById('add-item');
    const colorAlertCheckbox = document.getElementById('color-alert-checkbox');
    const soundCheckbox = document.getElementById('sound-checkbox');

    const alarmSound = document.getElementById('alarm-sound');

    let timeOffset = 0;
    let scheduleItems = [];
    let colorAlertEnabled = true;
    let soundEnabled = true;

    let activeTarget = null;
    const skippedInstances = new Set();
    const manualSkipHistory = [];
    const playedAlerts = new Set();

    function generateId() {
      if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
        return crypto.randomUUID();
      }
      return `id-${Date.now()}-${Math.floor(Math.random() * 1000000)}`;
    }

    function padZero(num) {
      return String(num).padStart(2, '0');
    }

    function formatDate(now) {
      const month = now.getMonth() + 1;
      const day = now.getDate();
      const dayOfWeek = week[now.getDay()];
      return `${month}<span class="unit">月</span>${day}<span class="unit">日(${dayOfWeek})</span>`;
    }

    function formatDateTime(now) {
      const dateHtml = formatDate(now);
      return `${dateHtml} <span class="mono">${now.getHours()}:${padZero(now.getMinutes())}:${padZero(now.getSeconds())}</span>`;
    }

    function resetTheme() {
      clockContainer.style.setProperty('--bg', '#000000');
      clockContainer.style.setProperty('--fg', '#ffffff');
    }

    function setAlertTheme(remainingSec) {
      if (!colorAlertEnabled) {
        resetTheme();
        return;
      }
      if (remainingSec <= 60) {
        clockContainer.style.setProperty('--bg', '#ff0000');
        clockContainer.style.setProperty('--fg', '#ffffff');
        return;
      }
      if (remainingSec <= 180) {
        clockContainer.style.setProperty('--bg', '#ffd400');
        clockContainer.style.setProperty('--fg', '#000000');
        return;
      }
      resetTheme();
    }

    function playSound(count = 1, intervalMs = 280) {
      const loop = async () => {
        for (let i = 0; i < count; i += 1) {
          alarmSound.currentTime = 0;
          try {
            await alarmSound.play();
          } catch (error) {
            console.error('音声の再生に失敗しました:', error);
            return;
          }
          if (i < count - 1) {
            await new Promise((resolve) => setTimeout(resolve, intervalMs));
          }
        }
      };
      loop();
    }

    function makeInstanceKey(itemId, targetDate) {
      const y = targetDate.getFullYear();
      const m = padZero(targetDate.getMonth() + 1);
      const d = padZero(targetDate.getDate());
      return `${itemId}-${y}${m}${d}`;
    }

    function resolveCandidates(now) {
      const candidates = [];

      for (const item of scheduleItems) {
        const [h, m] = item.time.split(':').map(Number);
        const targetDate = new Date(now);
        targetDate.setHours(h, m, 0, 0);

        if (targetDate.getTime() <= now.getTime()) {
          continue;
        }

        const key = makeInstanceKey(item.id, targetDate);
        if (skippedInstances.has(key)) {
          continue;
        }

        candidates.push({ item, targetDate, key });
      }

      candidates.sort((a, b) => a.targetDate.getTime() - b.targetDate.getTime());
      return candidates;
    }

    function pickNextTarget(now) {
      const candidates = resolveCandidates(now);
      return candidates[0] || null;
    }

    function hasNextTarget(now) {
      if (!activeTarget) {
        return false;
      }
      const candidates = resolveCandidates(now);
      return candidates.some((candidate) => candidate.key !== activeTarget.key);
    }

    function getLastReturnableTarget(now) {
      while (manualSkipHistory.length > 0) {
        const last = manualSkipHistory[manualSkipHistory.length - 1];
        if (!last || !(last.targetDate instanceof Date)) {
          manualSkipHistory.pop();
          continue;
        }
        if (last.targetDate.getTime() <= now.getTime()) {
          manualSkipHistory.pop();
          continue;
        }
        const stillExists = scheduleItems.some((item) => item.id === last.item.id);
        if (!stillExists) {
          manualSkipHistory.pop();
          continue;
        }
        return last;
      }
      return null;
    }

    function validateActiveTarget(now) {
      if (!activeTarget) {
        return;
      }

      const exists = scheduleItems.some((item) => item.id === activeTarget.item.id && item.time === activeTarget.item.time && item.title === activeTarget.item.title);
      if (!exists || skippedInstances.has(activeTarget.key)) {
        activeTarget = pickNextTarget(now);
      }
    }

    function triggerAlerts(remainingSec) {
      if (!soundEnabled || !activeTarget) {
        return;
      }

      const alertMap = {
        180: 1,
        120: 2,
        60: 3
      };

      const points = [180, 120, 60];
      for (const point of points) {
        if (remainingSec <= point) {
          const mark = `${activeTarget.key}-${point}`;
          if (!playedAlerts.has(mark)) {
            playSound(alertMap[point]);
            playedAlerts.add(mark);
          }
        }
      }
    }

    function renderNormalClock(now) {
      headingGroupElement.style.display = 'none';
      navButtons.style.display = 'none';
      backButton.style.display = 'none';
      skipButton.style.display = 'none';
      hourElement.textContent = String(now.getHours());
      minuteElement.textContent = padZero(now.getMinutes());
      secondElement.textContent = padZero(now.getSeconds());
      timeElement.style.display = 'flex';
      keeperTimeElement.style.display = 'none';

      if (timeElement.dataset.mode !== 'clock') {
        timeElement.dataset.mode = 'clock';
      }

      dateElement.innerHTML = formatDate(now);
      timerDisplayElement.textContent = '';
      resetTheme();
    }

    function renderTimekeeper(now) {
      if (!activeTarget) {
        activeTarget = pickNextTarget(now);
      }
      validateActiveTarget(now);

      if (!activeTarget) {
        renderNormalClock(now);
        return;
      }

      let remainingSec = Math.ceil((activeTarget.targetDate.getTime() - now.getTime()) / 1000);
      if (remainingSec <= 0) {
        activeTarget = pickNextTarget(new Date(now.getTime() + 1000));
        if (!activeTarget) {
          renderNormalClock(now);
          return;
        }
        remainingSec = Math.ceil((activeTarget.targetDate.getTime() - now.getTime()) / 1000);
      }

      headingGroupElement.style.display = 'block';
      headingElement.textContent = activeTarget.item.title || '(見出しなし)';
      const targetText = `${activeTarget.targetDate.getHours()}:${padZero(activeTarget.targetDate.getMinutes())}`;
      targetTimeElement.textContent = targetText;
      navButtons.style.display = 'flex';
      skipButton.style.display = hasNextTarget(now) ? 'inline-block' : 'none';
      backButton.style.display = getLastReturnableTarget(now) ? 'inline-block' : 'none';

      const min = Math.floor(remainingSec / 60);
      const sec = remainingSec % 60;
      timeElement.style.display = 'none';
      keeperTimeElement.style.display = 'block';

      if (timeElement.dataset.mode !== 'keeper') {
        timeElement.dataset.mode = 'keeper';
      }

      if (remainingSec < 60) {
        keeperTimeElement.textContent = String(remainingSec);
      } else {
        keeperTimeElement.innerHTML = `<span class="keeper-min">${min}</span><span class="keeper-sep">'</span><span class="keeper-sec">${padZero(sec)}</span>`;
      }

      dateElement.innerHTML = formatDateTime(now);
      timerDisplayElement.textContent = '';

      setAlertTheme(remainingSec);
      triggerAlerts(remainingSec);
    }

    function displayTime() {
      const now = new Date(Date.now() + timeOffset);
      if (scheduleItems.length === 0) {
        renderNormalClock(now);
      } else {
        renderTimekeeper(now);
      }
    }

    async function syncTimeWithNTP(maxRetries = 3, retryDelay = 3000) {
      if (!navigator.onLine) {
        timeOffset = 0;
        ntpStatusElement.className = 'ntp-error';
        ntpStatusElement.textContent = 'Offline';
        ntpStatusElement.title = 'オフラインのため、端末時刻を使用しています。';
        return;
      }

      ntpStatusElement.className = 'ntp-syncing';
      ntpStatusElement.textContent = 'NTP';
      ntpStatusElement.title = 'NTPサーバーと同期中...';

      for (let attempt = 1; attempt <= maxRetries; attempt += 1) {
        try {
          const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Tokyo');
          if (!response.ok) {
            throw new Error(`NTPサーバーエラー: ${response.status}`);
          }

          const data = await response.json();
          const serverTime = new Date(data.utc_datetime).getTime();
          timeOffset = serverTime - Date.now();

          ntpStatusElement.className = 'ntp-success';
          ntpStatusElement.title = `NTP同期成功 (${new Date().toLocaleTimeString()})`;
          return;
        } catch (error) {
          if (attempt < maxRetries) {
            await new Promise((resolve) => setTimeout(resolve, retryDelay));
          }
        }
      }

      timeOffset = 0;
      ntpStatusElement.className = 'ntp-error';
      ntpStatusElement.title = 'NTP同期失敗。端末時刻を使用しています。';
    }

    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch((err) => {
          console.error(`全画面表示エラー: ${err.message}`);
        });
      } else if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    }

    function saveSettingsToStorage() {
      const payload = {
        items: scheduleItems,
        colorAlertEnabled,
        soundEnabled
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(payload));
    }

    function loadSettingsFromStorage() {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) {
        scheduleItems = [];
        colorAlertEnabled = true;
        soundEnabled = true;
        return;
      }

      try {
        const parsed = JSON.parse(raw);
        scheduleItems = Array.isArray(parsed.items)
          ? parsed.items
            .map((item) => ({
              id: item.id || generateId(),
              title: String(item.title || '').trim(),
              time: String(item.time || '').trim()
            }))
            .filter((item) => /^\d{2}:\d{2}$/.test(item.time))
            .slice(0, MAX_ITEMS)
          : [];

        colorAlertEnabled = parsed.colorAlertEnabled !== false;
        soundEnabled = parsed.soundEnabled !== false;
      } catch (error) {
        console.error('設定の読み込みに失敗しました:', error);
        scheduleItems = [];
        colorAlertEnabled = true;
        soundEnabled = true;
      }
    }

    function getItemsFromModal() {
      const rows = scheduleListElement.querySelectorAll('.schedule-row');
      const items = [];

      for (const row of rows) {
        const titleInput = row.querySelector('input[type="text"]');
        const timeInput = row.querySelector('input[type="time"]');
        const id = row.dataset.id || generateId();
        const title = titleInput.value.trim();
        const time = timeInput.value;

        if (!time) {
          continue;
        }

        items.push({ id, title, time });
      }

      items.sort((a, b) => a.time.localeCompare(b.time));
      return items.slice(0, MAX_ITEMS);
    }

    function addRow(item = { id: generateId(), title: '', time: '' }) {
      if (scheduleListElement.children.length >= MAX_ITEMS) {
        return;
      }

      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.dataset.id = item.id;

      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.maxLength = 60;
      titleInput.placeholder = '見出し(メモ)';
      titleInput.value = item.title;

      const timeInput = document.createElement('input');
      timeInput.type = 'time';
      timeInput.value = item.time;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'remove-row';
      removeButton.textContent = '削除';

      row.appendChild(titleInput);
      row.appendChild(timeInput);
      row.appendChild(removeButton);
      scheduleListElement.appendChild(row);
    }

    function renderModalItems() {
      scheduleListElement.innerHTML = '';
      for (const item of scheduleItems) {
        addRow(item);
      }
      if (scheduleItems.length === 0) {
        addRow();
      }
      colorAlertCheckbox.checked = colorAlertEnabled;
      soundCheckbox.checked = soundEnabled;
      addItemButton.disabled = scheduleListElement.children.length >= MAX_ITEMS;
    }

    function openSettingsModal() {
      renderModalItems();
      settingsModal.classList.add('visible');
    }

    function closeSettingsModal() {
      settingsModal.classList.remove('visible');
    }

    function skipCurrentTarget() {
      if (!activeTarget) {
        return;
      }
      const now = new Date(Date.now() + timeOffset);
      if (activeTarget.targetDate.getTime() > now.getTime()) {
        manualSkipHistory.push({
          item: activeTarget.item,
          targetDate: new Date(activeTarget.targetDate.getTime()),
          key: activeTarget.key
        });
      }
      skippedInstances.add(activeTarget.key);
      activeTarget = pickNextTarget(now);
      displayTime();
    }

    function goBackTarget() {
      const now = new Date(Date.now() + timeOffset);
      const target = getLastReturnableTarget(now);
      if (!target) {
        displayTime();
        return;
      }
      manualSkipHistory.pop();
      skippedInstances.delete(target.key);
      activeTarget = {
        item: target.item,
        targetDate: new Date(target.targetDate.getTime()),
        key: target.key
      };
      displayTime();
    }

    function setupEventListeners() {
      clockContainer.addEventListener('click', toggleFullScreen);

      settingsIcon.addEventListener('click', (event) => {
        event.stopPropagation();
        openSettingsModal();
      });

      settingsModal.addEventListener('click', (event) => {
        if (event.target === settingsModal) {
          closeSettingsModal();
        }
      });

      document.getElementById('close-settings').addEventListener('click', closeSettingsModal);

      addItemButton.addEventListener('click', () => {
        addRow();
        addItemButton.disabled = scheduleListElement.children.length >= MAX_ITEMS;
      });

      scheduleListElement.addEventListener('click', (event) => {
        const removeButton = event.target.closest('.remove-row');
        if (!removeButton) {
          return;
        }

        const row = removeButton.closest('.schedule-row');
        if (row) {
          row.remove();
        }

        if (scheduleListElement.children.length === 0) {
          addRow();
        }

        addItemButton.disabled = scheduleListElement.children.length >= MAX_ITEMS;
      });

      document.getElementById('save-settings').addEventListener('click', () => {
        scheduleItems = getItemsFromModal();
        colorAlertEnabled = colorAlertCheckbox.checked;
        soundEnabled = soundCheckbox.checked;

        activeTarget = null;
        skippedInstances.clear();
        manualSkipHistory.length = 0;
        playedAlerts.clear();

        saveSettingsToStorage();
        closeSettingsModal();
        displayTime();
      });

      document.getElementById('clear-settings').addEventListener('click', () => {
        scheduleItems = [];
        colorAlertEnabled = true;
        soundEnabled = true;
        activeTarget = null;

        skippedInstances.clear();
        manualSkipHistory.length = 0;
        playedAlerts.clear();

        saveSettingsToStorage();
        renderModalItems();
        displayTime();
      });

      skipButton.addEventListener('click', (event) => {
        event.stopPropagation();
        skipCurrentTarget();
      });

      backButton.addEventListener('click', (event) => {
        event.stopPropagation();
        goBackTarget();
      });
    }

    (function init() {
      loadSettingsFromStorage();
      setupEventListeners();
      displayTime();
      setInterval(displayTime, 1000);
      syncTimeWithNTP();
      setInterval(syncTimeWithNTP, 3600000);

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((err) => {
              console.error('Service Worker registration failed:', err);
            });
        });
      }
    }());
  </script>
</body>

</html>
